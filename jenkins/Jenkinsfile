pipeline {
	agent {
		docker {
			image 'jenkins-with-docker-ansible:latest'
			args '-u root:root'
		}
	}
	
	parameters {
		choice(name: 'ACTION', choices: ['onboard', 'offboard'], description: 'Select action')
		string(name: 'EMPLOYEE_FILE', defaultValue: 'jane_doe.yml', description: 'Employee YAML filename')
	}

	environment {
		EMPLOYEE_PATH = "employees/${params.ACTION}/${params.EMPLOYEE_FILE}"
		JIRA_URL = 'https://on-off-board-automation.atlassian.net'
		JIRA_EMAIL = 'minjung10402@gmail.com'
		JIRA_PROJECT = 'HR'
	}
	
	stages {
		stage('Checkout Code') {
			steps {
				echo "Checking out code from GitHub ..."
				checkout scm
			}
		}

		stage('Parse Employee Data') {
			steps {
				script {
					echo "Reading employee file: ${EMPLOYEE_PATH}"

					// Read YAML file
					def employeeData = readYaml file: "${EMPLOYEE_PATH}"

					// Extract YAML file
					env.EMPLOYEE_NAME = employeeData.employee.name
					env.EMPLOYEE_EMAIL = employeeData.employee.email
					env.EMPLOYEE_ROLE = employeeData.employee.role
					env.EMPLOYEE_TEAM = employeeData.employee.team
					env.MANAGER_EMAIL = employeeData.employee.manager
	
					echo "Processing ${params.ACTION} for: ${env.EMPLOYEE_NAME}"
					echo "Email: ${env.EMPLOYEE_EMAIL}"
					echo "Role: ${env.EMPLOYEE_ROLE}"
					echo "Team: ${env.EMPLOYEE_TEAM}"
					echo "Manager: ${env.MANAGER_EMAIL"
				}
			}
		}
		
		stage('Create Jira Ticket') {
			steps {
				script {
					echo "Creating Jira ticket for ${env.EMPLOYEE_NAME}"
					
					withCredentials([string(credentialsId: 'jira-api-token', variable: 'JIRA_API_TOKEN')]) {
						def result = sh(
							script: """
								python3 scripts/create-jira-ticket.py \
									'${env.EMPLOYEE_NAME}' \
									'${env.EMPLOYEE_EMAIL}' \
									'${params.ACTION}'
							""",
							returnStdout: true
						).trim()
						
					// Extract ticket key from ouput
					env.JIRA_TICKET = result.split('=')[1]
					echo "✅ Jira ticket created: ${env.JIRA_TICKET}"
					}
				}
			}
		}
	
		stage('Run Ansible Playbook') {
			steps {
				script {
					echo "Running Ansible playbook for ${params.ACTION} ..."
					
					if (params.ACTION == 'onboard') {
						sh """
							ansible-playbook ansible/playbooks/onboard.yml \
								-i ansible/inventory/hosts \
								-e "employee_name='${env.EMPLOYEE_NAME}'" \
								-e "employee_email='${env.EMPLOYEE_EMAIL}'"
						"""
					} else {
						sh """
							ansible-playbook ansible/playbooks/offboard.yml \
								-i ansible/inventory/hosts \
								-e "employee_name='${env.EMPLOYEE_NAME}'" \
								-e "employee_email='${env.EMPLOYEE_EMAIL}'"

						"""
					}
				}
			}
		}
		
		stage('Send Webex Notifcation') {
			steps {
				script {
					echo "Sending Webex notication ..."
					
					withCredentials([
						string(credentialsId: 'webex-bot-token', variable: 'WEBEX_BOT_TOKEN'),
						string(credentialsId: 'webex-room-id', variable: 'WEBEX_ROOM_ID')
					]) {
						sh """
							python3 scripts/send-webex-notif.py \
								'${env.EMPLOYEE_NAME}' \
								'${params.ACTION}' \
								'${env.JIRA_TICKET}' \
								'${env.MANAGER_EMAIL}'
						"""
					}
					echo "✅ Notification sent to ${env.MANAGER_EMAIL}"
					//echo "${params.ACTION.capitalize()} completed for ${env.EMPLOYEE_NAME}"
					//placeholder for webex
				}
			}
		}
	}
	
	post {
		success {
			echo "Pipeline completed successfully!"
			echo "Employee: ${env.EMPLOYEE_NAME}"
			echo "Action: ${params.ACTION}"
			echo "Jira Ticket: ${env.JIRA_TICKET}"
		}
		failure {
			echo "Pipeline failed. Check logs above."
		}
	}
}
